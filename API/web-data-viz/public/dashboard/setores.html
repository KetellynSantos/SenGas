<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Setores- Sen Gás</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="icon" href="../assets/imgs/logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body ondblclick="buscarDadosSetor">
  <aside class="sidebar">
            <div class="sidebar-top">
                <img class="logo-img" src="../assets/imgs/logoLetraBranca.png.png" alt="Sen Gás logo">
            </div>

            <nav class="nav-dashboard">
                <ul>
                    <li><a  href="./dashboard.html">Dashboard </a></li>
                    <li><a class="active" href="./setores.html">Setores</a></li>
                    <li><a href="./historicoDashboard.html">Histórico</a></li>
                        <li><a href="https://brenogoal.atlassian.net/jira/software/c/projects/GS/list?jql=project+
%3D+%22GS%22+ORDER+BY+created+DESC&atlOrigin=eyJpIjoiZmJkMW
M4NDNmM2NjNDk0NGEwODYyN2NhOTViNjNhYTEiLCJwIjoiaiJ9" target="_blank">Suporte</a></li>


                </ul>
            </nav>
            <button class="button-sair" onclick="window.location.href='../index.html'">
                <i class="fa-solid fa-right-from-bracket" style="color: #fcfcfd;"></i> Sair </button>
            <p class="reserved">© 2025 SenGás All Rights Reserved</p>
        </aside>

    <main class="main-content">
        <header class="topbar">
            <div class="topbar-left">
                <h1>Setores</h1>
            </div>
            <div class="user">
                <span> Empresa Xpto </span>
                <img src="../assets/imgs/iconeUsuario.svg" alt="Usuária" class="avatar" onclick="window.location.href='admin.html'">
            </div>
        </header>
        <div class=" central">
            <section class="chart-section">
                <div class="chart-header">
                    <h3> Setor de Captação</h3>
                    
                </div>
                <div class="chart-placeholder">
                    <canvas id="graficoSetores1" width="800" height="340"></canvas>
                </div>
            </section>

            <section class="chart-section">
                <div class="chart-header">
                    <h3> Setor de Extração</h3>
                
                </div>      
                <div class="chart-placeholder">
                    <canvas id="graficoSetores2" width="800" height="340"></canvas>
                </div>
            </section>
        </div>    
        <div class=" central2">
            <section class="chart-section">
                <div class="chart-header">
                    <h3> Setor de Purificação</h3>
                   
                </div>
                <div class="chart-placeholder">
                    <canvas id="graficoSetores3" width="800" height="340"></canvas>
                </div>
            </section>

            <section class="chart-section">
                <div class="chart-header">
                    <h3> Setor de Armazenagem</h3>
                    
                </div>
                <div class="chart-placeholder">
                    <canvas id="graficoSetores4" width="800" height="340"></canvas>
                </div>
            </section>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const setor1 = document.getElementById('graficoSetores1');
const setor2 = document.getElementById('graficoSetores2');
const setor3 = document.getElementById('graficoSetores3');
const setor4 = document.getElementById('graficoSetores4');

let grafico1, grafico2, grafico3, grafico4; // <--- corrigido
const idEmpresa = localStorage.idEmpresa;
const idsetor = localStorage.setor

// função que faltava (corrigido)
function formatarData(data) {
    const d = new Date(data);
    if (isNaN(d)) return data;
    return d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR", {hour: "2-digit", minute: "2-digit"});
}

obterGrafico();

function obterGrafico() {
    fetch(`/setor/dados/${idEmpresa}`)
        .then(res => {
            if (!res.ok) throw "Erro ao buscar dados";
            return res.json();
        })
        .then(data => {
            console.log("DADOS RECEBIDOS:", data);

            const labels = data.map(item => formatarData(item.data));
            const valores = data.map(item => item.valor);

            plotarGrafico(labels, valores);
        })
        .catch(err => console.error(err));
}

function plotarGrafico(labels, valores) {

    if (grafico1) grafico1.destroy();
    if (grafico2) grafico2.destroy();
    if (grafico3) grafico3.destroy();
    if (grafico4) grafico4.destroy();

    grafico1 = new Chart(setor1, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: "Valores capturados",
                data: valores,
                borderColor: "#0099cc",
                fill: false,
                tension: 0.2
            }]
        }
    });

    grafico2 = new Chart(setor2, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: "Valores capturados",
                data: valores,
                borderColor: "#0099cc",
                fill: false,
                tension: 0.2
            }]
        }
    });

    grafico3 = new Chart(setor3, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: "Valores capturados",
                data: valores,
                borderColor: "#0099cc",
                fill: false,
                tension: 0.2
            }]
        }
    });

    grafico4 = new Chart(setor4, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: "Valores capturados",
                data: valores,
                borderColor: "#0099cc",
                fill: false,
                tension: 0.2
            }]
        }
    });
}


    </script>
</body>

</html>